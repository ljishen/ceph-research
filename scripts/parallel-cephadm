#!/usr/bin/env bash

set -euo pipefail

if [[ "$#" -eq 0 ]]; then
  cat <<EOF
Usage: $0 [OPTIONS] CEPHADM_ARGS

Options:
-h HOST_FILE, --hosts=HOST_FILE
                      hosts file (each line "[user@]host[:port]")
-H HOST_STRING, --host=HOST_STRING
                      additional host entries ("[user@]host[:port]")

Running the script without specifying hosts will only perform local execution.
EOF
  exit
fi

# https://stackoverflow.com/a/51548669
shopt -s expand_aliases
alias trace_on="set -x"
alias trace_off="{ set +x; } 2>/dev/null; echo"

err() {
  local exit_status="$1"
  shift
  printf "\\033[1;31m[ERROR] %s\\033[0m\\n" "$*" >&2
  exit "$exit_status"
}

host_params=()
cephadm_params=()

# loop positional params: https://unix.stackexchange.com/a/314041
for (( idx = 1; idx <= $#; idx++ )); do
  if [[ "${!idx}" == @(-h|-H|--hosts|--host) ]]; then
    host_params+=("${!idx}")
    (( idx++ ))
    host_params+=("${!idx}")
    continue
  fi

  if [[ "${!idx}" =~ ^(--hosts=|--host=) ]]; then
    host_params+=("${!idx}")
    continue
  fi

  cephadm_params+=("${!idx}")
done

# "@Q" quote each parameter: https://lwn.net/Articles/701009/
printf -v joined '%s, ' "${host_params[@]@Q}"
echo "[DEBUG] host_params:" "[${joined%, }]"
printf -v joined '%s, ' "${cephadm_params[@]@Q}"
echo "[DEBUG] cephadm_params:" "[${joined%, }]"

if (( "${#host_params[@]}" )); then
  if ! command -v "parallel-ssh" >/dev/null 2>&1; then
    err 1 "Please install parallel-ssh"
  fi
fi

: "${CEPHADM:="$PWD"/cephadm}"
if ! [[ -x "$CEPHADM" ]]; then
  echo "[INFO] download cephadm"
  trace_on
  curl --silent --remote-name --location https://github.com/ceph/ceph/raw/octopus/src/cephadm/cephadm
  chmod +x cephadm
  trace_off
fi

if (( "${#host_params[@]}" )); then
  trace_on
  parallel-ssh \
    -O StrictHostKeyChecking=no \
    -O UserKnownHostsFile=/dev/null \
    -O GlobalKnownHostsFile=/dev/null \
    -O LogLevel=ERROR \
    --par=8 \
    --inline \
    --send-input \
    --print \
    "${host_params[@]}" \
    "sudo python3 -u - ${cephadm_params[*]}" < "${CEPHADM}"
  trace_off
else
  sudo "$CEPHADM" "${cephadm_params[@]}"
fi
